<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Editar Perfil</title>
    <link rel="stylesheet" th:href="@{/css/homepage.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

<div th:replace="~{fragments/layout :: mainHeader}"></div>

<div th:replace="~{fragments/layout :: sidebar}"></div>

<div style="padding: 20px;">
    <h1>Editar Perfil</h1>
    <form id="perfil-form" th:action="@{/usuario/editar}" method="post">

        <label for="nombre">Nombre:</label>
        <input type="text" id="nombre" name="nombre" th:value="${usuario.nombre}" required><br><br>

        <label for="apellido">Apellido:</label>
        <input type="text" id="apellido" name="apellido" th:value="${usuario.apellido}" required><br><br>

        <label for="fechaNacimiento">Fecha de Nacimiento:</label>
        <input type="date" id="fechaNacimiento" name="fechaNacimiento" th:value="${usuario.fechaNacimiento}" required><br><br>

        <label for="email">Email:</label>
        <input type="email" id="email" name="email" th:value="${usuario.email}" readonly><br><br>

        <button type="submit">Guardar Cambios</button>
    </form>
</div>

<div th:replace="~{fragments/layout :: authModals}"></div>
<div th:replace="~{fragments/layout :: pageScripts}"></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Selector preciso para el formulario de perfil
        const form = document.getElementById('perfil-form');

        // 2. Manejar el evento de envÃ­o
        form.addEventListener('submit', function(event) {
            event.preventDefault(); // ðŸ›‘ CrÃ­tico: Detener el envÃ­o HTML que envÃ­a form-urlencoded

            const identidadNueva = {
                nombre: document.getElementById('nombre').value,
                apellido: document.getElementById('apellido').value,
                // El input[type="date"] devuelve el formato ISO (YYYY-MM-DD), que Java espera
                fechaNacimiento: document.getElementById('fechaNacimiento').value
            };

            // ðŸš€ CORRECCIÃ“N: Usar form.action, que contiene el valor de th:action="@{/usuario/editar}"
            fetch(form.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(identidadNueva)
            })
                .then(response => {
                    if (response.ok) {
                        alert('Cambios de identidad guardados exitosamente.');
                        // Recargar para que el header refleje los posibles cambios de nombre
                        window.location.reload();
                    } else if (response.status === 400 || response.status === 404) {
                        // Capturar errores comunes del microservicio
                        alert('Error: No se pudo guardar la identidad. (CÃ³digo: ' + response.status + ').');
                    } else {
                        return response.text().then(text => { throw new Error(text) });
                    }
                })
                .catch(error => {
                    console.error('Error al guardar cambios:', error);
                    alert('Fallo al guardar: ' + error.message);
                });
        });
    });
</script>
</body>
</html>