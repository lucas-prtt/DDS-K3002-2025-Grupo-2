<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" >
<body>

<th:block th:fragment="mainHeader">
    <header>
        <div class="logo-container">
            <a th:href="@{/}" class="logo">FD</a>
            <button id="hamburgerBtn" class="hamburger-btn">&#9776;</button>
        </div>

        <th:block th:if="${principal == null}">
            <button id="openLoginModal" class="login-button-header">Iniciar Sesión</button>
        </th:block>

        <div th:if="${principal != null}" class="user-menu-container">
            <button id="userMenuBtn" class="user-profile-button" aria-expanded="false">
                <span th:text="${principal.attributes['name']}">Nombre de Usuario</span>
                <svg class="dropdown-arrow" viewBox="0 0 24 24">
                    <path d="M7 10l5 5 5-5z"/>
                </svg>
            </button>
            <div id="userDropdown" class="user-dropdown-menu hidden">

                <a th:if="${isAdmin}"
                   th:href="@{/solicitudes-pendientes}"
                   class="dropdown-item">
                    <i class="fas fa-list-alt"></i> Solicitudes Pendientes
                </a>


                <a th:href="@{/mis-hechos}" class="dropdown-item">
                    <i class="fas fa-file-alt"></i> Mis Hechos
                </a>
                <a th:href="@{/editar-perfil}" class="dropdown-item">
                    <i class="fas fa-user-edit"></i> Editar Perfil
                </a>
                <hr class="dropdown-divider">
                <form th:action="@{/logout}" method="post">
                    <button type="submit" class="dropdown-item">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </button>
                </form>
            </div>
        </div>
    </header>
</th:block>

<th:block th:fragment="sidebar">
    <div id="sidebar" class="sidebar">
        <button id="closeSidebar" class="close-sidebar">&times;</button>
        <a th:href="@{/}" class="sidebar-link">Home</a>
        <a th:href="@{/subir-hechos}" class="sidebar-link">Subir Hechos</a>
    </div>
</th:block>

</body>
</html>

<th:block th:fragment="authModals">
    <div id="loginModal" class="modal hidden">
        <div class="modal-content">
            <h1>Iniciar Sesión</h1>
        </div>
    </div>


</th:block>

<th:block th:fragment="pageScripts">
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', () => {
            // --------- Elementos del DOM principales ----------
            const openLoginBtn = document.getElementById('openLoginModal'); // El botón en el header
            const sidebar = document.getElementById('sidebar');
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const closeSidebarBtn = document.getElementById('closeSidebar');
            const userMenuBtn = document.getElementById('userMenuBtn');
            const userDropdown = document.getElementById('userDropdown');

            // --- Funciones de Modales y Utilidad (Se mantienen por si hay otras modales) ---

            function closeAllModals() {
                // Solo cerramos otras modales si existen
                const loginModal = document.getElementById('loginModal');
                const forgotPasswordModal = document.getElementById('forgotPasswordModal');
                const registerModal = document.getElementById('registerModal');

                // Cierre seguro de modales
                const modals = [loginModal, forgotPasswordModal, registerModal];
                modals.forEach(modal => {
                    if (modal) {
                        modal.classList.add("hidden");
                        modal.style.display = "none";
                    }
                });
                document.body.style.overflow = 'auto';
            }

            // --------- ASIGNACIÓN DE EVENTOS A ELEMENTOS DEL HTML ----------

            // 1. Botón de "Iniciar Sesión" del header: ¡REDIRECCIÓN INMEDIATA!
            if (openLoginBtn) {
                openLoginBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Ejecuta la redirección inmediatamente
                    window.location.href = '/oauth2/authorization/keycloak';
                });
            }

            // 2. Lógica del Sidebar y Menú de Usuario (SE MANTIENE)
            if (hamburgerBtn) {
                hamburgerBtn.addEventListener('click', () => {
                    sidebar.style.width = "300px";
                    document.body.style.overflow = 'hidden';
                });
            }
            if (closeSidebarBtn) {
                closeSidebarBtn.addEventListener('click', () => {
                    sidebar.style.width = "0";
                    document.body.style.overflow = 'auto';
                });
            }
            if (userMenuBtn) {
                userMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (userDropdown) {
                        userDropdown.classList.toggle('hidden');
                        userMenuBtn.setAttribute('aria-expanded', userDropdown.classList.contains('hidden') ? 'false' : 'true');
                    }
                });
            }
            window.addEventListener('click', (event) => {
                const isClickInsideMenu = userMenuBtn && userMenuBtn.contains(event.target) || userDropdown && userDropdown.contains(event.target);
                if (!isClickInsideMenu && userDropdown && !userDropdown.classList.contains('hidden')) {
                    userDropdown.classList.add('hidden');
                    userMenuBtn.setAttribute('aria-expanded', 'false');
                }
            });

            // 3. Cerrar Modales con tecla ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeAllModals();
                }
            });

            // --- Otros Listeners de Modales (Mantenidos si están en el HTML) ---
            const closeButtons = document.querySelectorAll('.close-button');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', closeAllModals);
            });
            window.addEventListener('click', (event) => {
                if (event.target.classList.contains("modal")) {
                    closeAllModals();
                }
            });

        });
    </script>
</th:block>

</body>
</html>