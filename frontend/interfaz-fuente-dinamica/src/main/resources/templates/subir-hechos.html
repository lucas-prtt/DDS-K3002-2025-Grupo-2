<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crear nuevo hecho</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/subir-hechos.css}">
</head>
<body>

<div class="modal-fact">
  <div class="modal-header">
    <h2>Crear nuevo hecho</h2>
    <span class="close-btn" onclick="window.location.href='/';">&times;</span>
  </div>

  <form id="fact-form">
    <div class="form-group">
      <label for="titulo">Título del hecho</label>
      <input type="text" id="titulo" name="titulo" required>
    </div>

    <div class="form-group">
      <label for="descripcion">Descripción</label>
      <textarea id="descripcion" name="descripcion" required></textarea>
    </div>

    <div class="form-group">
      <label for="categoria">Categoría</label>
      <input type="text" id="categoria" name="categoria">
    </div>

    <div class="form-group">
      <label for="latitud">Latitud</label>
      <input type="number" step="any" id="latitud" name="latitud">
    </div>

    <div class="form-group">
      <label for="longitud">Longitud</label>
      <input type="number" step="any" id="longitud" name="longitud">
    </div>

    <div class="form-group">
      <label for="fechaAcontecimiento">Fecha de acontecimiento</label>
      <input type="datetime-local" id="fechaAcontecimiento" name="fechaAcontecimiento">
    </div>

    <div class="form-group">
      <label for="contenidoTexto">Contenido</label>
      <textarea id="contenidoTexto" name="contenidoTexto"></textarea>
    </div>

    <div class="checkbox-group">
      <input type="checkbox" id="anonimato">
      <label for="anonimato">Publicar de forma anónima</label>
    </div>

    <fieldset class="multimedia-container">
      <legend>Contenido Multimedia (Opcional)</legend>

      <div id="multimedia-list">
      </div>

      <button type="button" class="btn upload-btn" onclick="addMultimediaField()" style="width: 100%; margin-top: 15px;">
        + Agregar Multimedia
      </button>
    </fieldset>
    <div class="button-container">
      <button type="button" class="btn btn-cancel" onclick="window.location.href='/';">Cancelar</button>
      <button type="submit" class="btn btn-publish">Publicar</button>
    </div>
  </form>
</div>

<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('fact-form');
    const multimediaListContainer = document.getElementById('multimedia-list');

    // Datos de usuario
    const userData = {
      nombre: [[${principal != null ? principal.claims['given_name'] : null}]],
    apellido: [[${principal != null ? principal.claims['family_name'] : null}]],
    fechaNacimiento: [[${principal != null ? principal.claims['birthdate'] : null}]],
    contribuyenteId: [[${session.CONTRIBUYENTE_ID}]],
            esAdministrador: [[${isAdmin}]]
  };

    // ===============================================
    // FUNCIONES DINÁMICAS PARA AGREGAR/QUITAR MULTIMEDIA
    // ===============================================

    window.addMultimediaField = function() {
      const multimediaItem = document.createElement('div');
      // Clase para identificar el grupo en el momento de envío
      multimediaItem.className = 'multimedia-item-group';
      multimediaItem.innerHTML = `
            <div class="form-group" style="display: flex; gap: 10px; align-items: flex-end;">
                <div style="flex: 3;">
                    <label>URL</label>
                    <input type="url" name="multimediaUrl" class="multimedia-url-input" placeholder="http://o-https://..." required>
                </div>
                <div>
                    <button type="button" class="delete-btn" onclick="removeMultimediaField(this)" style="padding: 12px; margin-bottom: 0;">&times;</button>
                </div>
            </div>
        `;
      multimediaListContainer.appendChild(multimediaItem);
    };

    // Función para eliminar el grupo de campos
    window.removeMultimediaField = function(button) {
      button.closest('.multimedia-item-group').remove();
    };

    // ===============================================
    // MANEJO DEL ENVÍO
    // ===============================================
    form.addEventListener('submit', function(event) {
      event.preventDefault();

      const esAnonimo = form.anonimato.checked;

      // 1. CONSTRUCCIÓN DEL ARRAY contenidoMultimedia (CORREGIDO)
      const contenidoMultimedia = [];
      const multimediaGroups = multimediaListContainer.querySelectorAll('.multimedia-item-group');

      multimediaGroups.forEach(group => {
        // [ELIMINADO]: const tipoInput = group.querySelector('.multimedia-tipo-input');
        const urlInput = group.querySelector('.multimedia-url-input');

        // La condición se simplifica: solo se necesita la url.
        if (urlInput && urlInput.value) {
          contenidoMultimedia.push({
            url: urlInput.value // <-- CORRECTO: Solo envía la URL
          });
        }
      });
      // El array contenidoMultimedia puede ser [], [obj1], [obj1, obj2], etc.

      // 2. Construir el objeto AUTOR... (sin cambios)
      let autorObject = null;
      if (!esAnonimo && userData.contribuyenteId) {
        autorObject = {
          nombre: userData.nombre ,
          apellido: userData.apellido ,
          fechaNacimiento: userData.fechaNacimiento ,
          contribuyente: {
            contribuyenteId: String(userData.contribuyenteId),
            esAdministrador: userData.esAdministrador
          }
        };
      }

      const formData = {
        titulo: form.titulo.value,
        descripcion: form.descripcion.value,
        categoria: {
          nombre: form.categoria.value || null
        },
        ubicacion: {
          latitud: parseFloat(form.latitud.value) || 0,
          longitud: parseFloat(form.longitud.value) || 0
        },
        fechaAcontecimiento: form.fechaAcontecimiento.value ? new Date(form.fechaAcontecimiento.value).toISOString() : null,
        origen: "CONTRIBUYENTE",
        contenidoTexto: form.contenidoTexto.value,
        contenidoMultimedia: contenidoMultimedia, // Array de {url: ...}
        anonimato: esAnonimo,
        autor: autorObject
      };

      // Petición al endpoint del propio backend
      fetch('/subir-hechos-post', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
      })
              .then(response => {
                if (response.ok) {
                  return response.json();
                } else if (response.status === 401) {
                  throw new Error('No autorizado. Vuelve a iniciar sesión.');
                }
                throw new Error('Error al enviar el formulario. Estado: ' + response.status);
              })
              .then(data => {
                console.log('Success:', data);
                alert('Hecho publicado con éxito.');
                window.location.href = '/';
              })
              .catch((error) => {
                console.error('Error:', error);
                alert('Error: ' + error.message);
              });
    });
  });
</script>

</body>
</html>