<th:block th:fragment="pageScripts">
    <script src="/js/filtrar-mapa.js" defer></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="/js/search-bar.js" defer></script>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', () => {
            let hechos = /*[[${hechos}]]*/ [];

            console.log("Hechos en JS:", hechos);

            const map = L.map('map', {zoomControl: false})
                    .setView([-34.6037, -58.3816], 5);

            L.control.zoom({ position: 'topright' }).addTo(map);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                noWrap: true
            }).addTo(map);

            const customIcon = L.icon({
                iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="41" viewBox="0 0 25 41">
                    <path fill="#DC2626" stroke="#ffffff" stroke-width="1.5"
                          d="M12.5 0C5.596 0 0 5.596 0 12.5c0 1.933.439 3.761 1.217 5.394L12.5 41l11.283-23.106A12.42 12.42 0 0 0 25 12.5C25 5.596 19.404 0 12.5 0z"/>
                    <circle fill="#ffffff" cx="12.5" cy="12.5" r="5"/>
                </svg>
                `),
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [0, -41]
            });

            const markersLayer = L.featureGroup().addTo(map);

            hechos.forEach(h => {
                if (h.latitud && h.longitud) {
                    const popupContent = `
                        <div style="text-align: center; max-width: 200px;">
                            <b style="word-wrap: break-word;">${h.titulo}</b>
                            <br><br>
                            <a href="/hechos/${h.id}"
                               class="inline-block px-3 py-1.5 bg-red-700 text-white no-underline rounded text-sm hover:bg-red-800">
                                Ver hecho
                            </a>
                        </div>
                    `;
                    try {
                        L.marker([h.latitud, h.longitud], {icon: customIcon})
                                .addTo(markersLayer)
                                .bindPopup(popupContent);
                    } catch (e) {
                        console.error("Error al crear marcador para hecho:", h, e);
                    }
                } else {
                    console.warn("Hecho sin ubicación válida:", h);
                }
            });

            if (markersLayer.getLayers().length > 0) {
                map.fitBounds(markersLayer.getBounds().pad(0.1));
            }

            map.on('click', function(e) {
                const lat = e.latlng.lat.toFixed(6);
                const lng = e.latlng.lng.toFixed(6);

                const filtroLatitud = document.getElementById('filtroLatitud');
                const filtroLongitud = document.getElementById('filtroLongitud');

                if (filtroLatitud) filtroLatitud.value = lat;
                if (filtroLongitud) filtroLongitud.value = lng;

                console.log('Ubicación seleccionada:', lat, lng);
            });
        })
    </script>
</th:block>

<th:block th:fragment="pageStyles">
    <link rel="stylesheet" type="text/css" th:href="@{/css/pagination.css}" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        .pagination-controls {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
    </style>
</th:block>

<th:block th:replace="~{fragments/layout :: layout(~{::main}, ${true})}">
    <main class="relative h-[86vh] w-full">
        <div id="map" class="h-full w-full m-0 p-0 z-[1] relative"></div>

        <div class="absolute top-2.5 left-2.5 z-[1000] max-w-[380px]">
            <th:block th:replace="~{fragments/modal :: modalFiltros}"/>
        </div>

        <th:block th:replace="~{fragments/pagination-controls :: paginationControls(
            @{/mapa(page=${currentPage - 1}, size=${pageSize}, categoria=${categoria},
            fechaReporteDesde=${fechaReporteDesde}, fechaReporteHasta=${fechaReporteHasta},
            fechaAcontecimientoDesde=${fechaAcontecimientoDesde}, fechaAcontecimientoHasta=${fechaAcontecimientoHasta}, search=${search})},
            @{/mapa(page=${currentPage + 1}, size=${pageSize}, categoria=${categoria},
            fechaReporteDesde=${fechaReporteDesde}, fechaReporteHasta=${fechaReporteHasta},
            fechaAcontecimientoDesde=${fechaAcontecimientoDesde}, fechaAcontecimientoHasta=${fechaAcontecimientoHasta}, search=${search})}
        )}" />
    </main>
</th:block>
