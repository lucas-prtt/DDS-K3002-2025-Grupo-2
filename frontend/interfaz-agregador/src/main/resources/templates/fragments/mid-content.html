<div th:fragment="mapa(hechos)">
    <!-- Leaflet CSS y JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        #map {
            height: calc(100vh - 120px); /* Altura casi completa de la ventana menos el header */
            width: 100%;
            margin: 0;
            padding: 0;
            position: relative;
            z-index: 1; /* Asegurar que el mapa esté por debajo del dropdown */
        }
    </style>

    <div id="map"></div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        var hechos = /*[[${hechos}]]*/ [];

        console.log("Hechos en JS:", hechos); // Para verificar que llegan correctamente

        // Inicializamos el mapa centrado en Buenos Aires
        const map = L.map('map').setView([-34.6037, -58.3816], 5);

        // Capa de mapa de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            noWrap: true
        }).addTo(map);

        // Icono personalizado con color #4f46e5
        const customIcon = L.icon({
            iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="41" viewBox="0 0 25 41">
                    <path fill="red" stroke="#ffffff" stroke-width="1.5" d="M12.5 0C5.596 0 0 5.596 0 12.5c0 1.933.439 3.761 1.217 5.394L12.5 41l11.283-23.106A12.42 12.42 0 0 0 25 12.5C25 5.596 19.404 0 12.5 0z"/>
                    <circle fill="#ffffff" cx="12.5" cy="12.5" r="5"/>
                </svg>
            `),
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [0, -41]
        });

        // Grupo de marcadores para poder borrarlos fácilmente si se implementara AJAX en el futuro
        const markersLayer = L.featureGroup().addTo(map);

        // Agregamos un marker por cada hecho
        hechos.forEach(h => {
            if (h.ubicacion && h.ubicacion.latitud && h.ubicacion.longitud) {
                const popupContent = `
                    <div style="text-align: center; max-width: 200px;">
                        <b style="word-wrap: break-word;">${h.titulo}</b>
                        <br><br>
                        <a href="/hechos/${h.id}"
                           style="display: inline-block; padding: 6px 12px; background-color: #4f46e5; color: white; text-decoration: none; border-radius: 4px; font-size: 0.9em;">
                           Ver hecho
                        </a>
                    </div>
                `;
                try {
                    L.marker([h.ubicacion.latitud, h.ubicacion.longitud], {icon: customIcon})
                        .addTo(markersLayer) // Añadir al grupo
                        .bindPopup(popupContent);
                } catch (e) {
                    console.error("Error al crear marcador para hecho:", h, e);
                }
            } else {
                console.warn("Hecho sin ubicación válida:", h);
            }
        });

        // Ajustar el zoom para mostrar todos los marcadores (si hay alguno)
        if (markersLayer.getLayers().length > 0) {
            map.fitBounds(markersLayer.getBounds().pad(0.1)); // pad(0.1) añade un pequeño margen
        }

        /*]]>*/
    </script>

    <!-- Controles de Paginación -->
    <div class="pagination-controls">
        <a th:if="${hasPrevious}"
           th:href="@{/mapa(page=${currentPage - 1}, size=${pageSize}, categoria=${categoria}, fechaReporteDesde=${fechaReporteDesde}, fechaReporteHasta=${fechaReporteHasta}, fechaAcontecimientoDesde=${fechaAcontecimientoDesde}, fechaAcontecimientoHasta=${fechaAcontecimientoHasta}, search=${search})}"
           class="pagination-btn">
            ← Anterior
        </a>
        <!-- Enlace deshabilitado si no hay página anterior -->
        <a th:unless="${hasPrevious}" class="pagination-btn" disabled>← Anterior</a>

        <span class="pagination-info">Página <span th:text="${currentPage + 1}"></span> de <span th:text="${totalPages}"></span></span>

        <a th:if="${hasNext}"
           th:href="@{/mapa(page=${currentPage + 1}, size=${pageSize}, categoria=${categoria}, fechaReporteDesde=${fechaReporteDesde}, fechaReporteHasta=${fechaReporteHasta}, fechaAcontecimientoDesde=${fechaAcontecimientoDesde}, fechaAcontecimientoHasta=${fechaAcontecimientoHasta}, search=${search})}"
           class="pagination-btn">
            Siguiente →
        </a>
        <!-- Enlace deshabilitado si no hay página siguiente -->
        <a th:unless="${hasNext}" class="pagination-btn" disabled>Siguiente →</a>
    </div>
</div>

<!-- Fragmento hechosRecientes -->
<div th:fragment="hechosRecientes(hechos)">
    <div id="hechos-recientes-panel" class="bg-white rounded-lg shadow-lg"
         style="width: 100%; max-width: 380px;">
        <div class="flex justify-between items-center p-4 pb-3">
            <h3 class="text-xl font-bold">Hechos Recientes</h3>
            <button id="toggle-hechos-btn" class="text-gray-600 hover:text-gray-900 focus:outline-none transition-transform duration-200">
                <svg id="chevron-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
            </button>
        </div>
        <hr id="hechos-separator" class="mb-4">

        <div id="hechos-content" class="px-4 pb-4 max-h-96 overflow-y-auto">
            <div class="space-y-2">
                <!-- Reducción de padding (p-2), font-size (text-xs) y margin (mb-0.5) -->
                <a th:each="hecho : ${hechos}"
                   th:href="@{/hechos/{id}(id=${hecho.id})}"
                   class="block p-2 hover:bg-gray-50 rounded-lg transition-colors border-b last:border-b-0">
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <h5 class="font-medium text-gray-900 mb-0.5 truncate" th:text="${hecho.titulo}">Título del hecho</h5>
                            <p class="text-xs text-gray-600 truncate" th:text="${hecho.direccion != null ? hecho.direccion : 'Sin ubicación'}">
                                Dirección del hecho
                            </p>
                        </div>
                        <div class="text-right ml-3 flex-shrink-0">
                            <!-- Tamaño de fuente reducido a text-xs -->
                            <small class="text-xs text-gray-500 whitespace-nowrap">
                                <span th:if="${hecho.fechaCarga != null}" th:with="ahora=${T(java.time.LocalDateTime).now()}, duracion=${T(java.time.Duration).between(hecho.fechaCarga, ahora)}">
                                    <span th:if="${duracion.toDays() > 0}" th:text="${'Hace ' + duracion.toDays() + (duracion.toDays() == 1 ? ' día' : ' días')}"></span>
                                    <span th:if="${duracion.toDays() == 0 && duracion.toHours() > 0}" th:text="${'Hace ' + duracion.toHours() + (duracion.toHours() == 1 ? ' hora' : ' horas')}"></span>
                                    <span th:if="${duracion.toDays() == 0 && duracion.toHours() == 0 && duracion.toMinutes() > 0}" th:text="${'Hace ' + duracion.toMinutes() + ' min'}"></span>
                                    <span th:if="${duracion.toDays() == 0 && duracion.toHours() == 0 && duracion.toMinutes() == 0}">Hace un momento</span>
                                </span>
                                <span th:unless="${hecho.fechaCarga != null}">Fecha N/A</span>
                            </small>
                        </div>
                    </div>
                </a>
            </div>

            <div th:if="${hechos == null || hechos.isEmpty()}" class="text-center text-gray-500 py-4 text-sm"> <!-- Ajustado tamaño de fuente -->
                No hay hechos recientes
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById('toggle-hechos-btn');
            const content = document.getElementById('hechos-content');
            const separator = document.getElementById('hechos-separator');
            const chevron = document.getElementById('chevron-icon');
            let isExpanded = true;

            if (toggleBtn && content && separator && chevron) { // Verificar si los elementos existen
                toggleBtn.addEventListener('click', function() {
                    isExpanded = !isExpanded;
                    content.style.display = isExpanded ? 'block' : 'none';
                    separator.style.display = isExpanded ? 'block' : 'none';
                    chevron.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(-90deg)';
                });
            } else {
                console.error("No se encontraron todos los elementos para el panel de hechos recientes.");
            }
        });
    </script>
</div>

<div th:fragment="filtros">
    <div id="filtros-panel" class="bg-white rounded-lg shadow-lg"
         style="width: 100%; max-width: 380px;">

        <div class="flex justify-between items-center p-4 pb-3">
            <h3 class="text-lg font-bold">Filtros</h3>
            <div class="flex items-center gap-1">
                <button id="btn-aplicar-filtros" class="px-3 py-1 text-xs text-white font-semibold rounded-lg bg-red-700 hover:bg-red-800">
                    Aplicar
                </button>
                <button id="toggle-filtros-btn" class="text-gray-600 hover:text-gray-900 focus:outline-none transition-transform duration-200">
                    <svg id="chevron-filtros-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </button>
            </div>
        </div>
        <hr id="filtros-separator" class="mb-4">

        <div id="filtros-content" class="px-4 pb-4">
            <form id="form-filtros">
                <!-- Categoría -->
                <div class="mb-3">
                    <label for="categoria" class="block text-xs font-medium text-gray-700 mb-1">Categoría</label>
                    <input type="text"
                           id="categoria"
                           name="categoria"
                           th:value="${categoria}"
                           class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded-full focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none"
                           placeholder="Ingrese categoría...">
                </div>

                <!-- Fecha reporte -->
                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Fecha reporte</label>
                    <div class="flex flex-col gap-1">
                        <input type="datetime-local"
                               id="fechaReporteDesde"
                               name="fechaReporteDesde"
                               th:value="${fechaReporteDesde}"
                               class="w-full px-2 py-1 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none"
                               style="font-size: 0.7rem;">
                        <input type="datetime-local"
                               id="fechaReporteHasta"
                               name="fechaReporteHasta"
                               th:value="${fechaReporteHasta}"
                               class="w-full px-2 py-1 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none"
                               style="font-size: 0.7rem;">
                    </div>
                </div>

                <!-- Fecha acontecimiento -->
                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Fecha acontecimiento</label>
                    <div class="flex flex-col gap-1">
                        <input type="datetime-local"
                               id="fechaAcontecimientoDesde"
                               name="fechaAcontecimientoDesde"
                               th:value="${fechaAcontecimientoDesde}"
                               class="w-full px-2 py-1 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none"
                               style="font-size: 0.7rem;">
                        <input type="datetime-local"
                               id="fechaAcontecimientoHasta"
                               name="fechaAcontecimientoHasta"
                               th:value="${fechaAcontecimientoHasta}"
                               class="w-full px-2 py-1 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none"
                               style="font-size: 0.7rem;">
                    </div>
                </div>

                <!-- Botón limpiar filtros -->
                <button type="button"
                        id="btn-limpiar-filtros"
                        class="w-full mt-2 px-3 py-1.5 text-xs text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    Limpiar filtros
                </button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const btnAplicar = document.getElementById('btn-aplicar-filtros');
            const btnLimpiar = document.getElementById('btn-limpiar-filtros');
            const form = document.getElementById('form-filtros');
            const toggleBtn = document.getElementById('toggle-filtros-btn');
            const content = document.getElementById('filtros-content');
            const separator = document.getElementById('filtros-separator');
            const chevron = document.getElementById('chevron-filtros-icon');
            let isExpanded = true;

            // Toggle minimizar/expandir
            toggleBtn.addEventListener('click', function() {
                isExpanded = !isExpanded;

                if (isExpanded) {
                    content.style.display = 'block';
                    separator.style.display = 'block';
                    chevron.style.transform = 'rotate(0deg)';
                } else {
                    content.style.display = 'none';
                    separator.style.display = 'none';
                    chevron.style.transform = 'rotate(-90deg)';
                }
            });

            // Aplicar filtros
            btnAplicar.addEventListener('click', function(e) {
                e.preventDefault();

                const categoria = document.getElementById('categoria').value;
                const fechaReporteDesde = document.getElementById('fechaReporteDesde').value;
                const fechaReporteHasta = document.getElementById('fechaReporteHasta').value;
                const fechaAcontecimientoDesde = document.getElementById('fechaAcontecimientoDesde').value;
                const fechaAcontecimientoHasta = document.getElementById('fechaAcontecimientoHasta').value;

                // Obtener los parámetros actuales de la URL
                const currentUrl = new URL(window.location.href);
                const params = new URLSearchParams(currentUrl.search);

                // Actualizar o agregar los parámetros de filtro
                if (categoria) {
                    params.set('categoria', categoria);
                } else {
                    params.delete('categoria');
                }

                if (fechaReporteDesde) {
                    params.set('fechaReporteDesde', fechaReporteDesde);
                } else {
                    params.delete('fechaReporteDesde');
                }

                if (fechaReporteHasta) {
                    params.set('fechaReporteHasta', fechaReporteHasta);
                } else {
                    params.delete('fechaReporteHasta');
                }

                if (fechaAcontecimientoDesde) {
                    params.set('fechaAcontecimientoDesde', fechaAcontecimientoDesde);
                } else {
                    params.delete('fechaAcontecimientoDesde');
                }

                if (fechaAcontecimientoHasta) {
                    params.set('fechaAcontecimientoHasta', fechaAcontecimientoHasta);
                } else {
                    params.delete('fechaAcontecimientoHasta');
                }

                // Redirigir con todos los parámetros (filtros + search si existe)
                window.location.href = '/mapa?' + params.toString();
            });

            // Limpiar filtros
            btnLimpiar.addEventListener('click', function() {
                form.reset();
                window.location.href = '/mapa';
            });
        });
    </script>
</div>