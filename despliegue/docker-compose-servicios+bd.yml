version: "3.9"

services:
  # Eureka Server - Service Discovery
  #todo: quitarlo y ponerlo en un compose aparte
  eureka-server:
    build:
      context: ..
      dockerfile: backend/EurekaServer/Dockerfile
    ports:
      - "8761:8761"
    networks:
      - micro_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Base de datos para Agregador
  agregador-db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: agregador
      TZ: America/Argentina/Buenos_Aires
    ports:
      - "3308:3306"
    volumes:
      - agregador-data:/var/lib/mysql
    networks:
      - micro_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Servicio Agregador
  agregador:
    build:
      context: ..
      dockerfile: backend/agregador/Dockerfile
    ports:
      - "8084:8084"
    depends_on:
      agregador-db:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    environment:
      # Base de datos
      SPRING_DATASOURCE_URL: jdbc:mysql://agregador-db:3306/agregador?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      # ID del agregador
      AGREGADOR_ID: 515a5019-9f1a-435e-a320-ebc99687bdc7
      # Eureka
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_HOSTNAME: agregador
      # Observabilidad (opcional, si tienes Zipkin)
      # MANAGEMENT_ZIPKIN_TRACING_ENDPOINT: http://zipkin:9411/api/v2/spans
    networks:
      - micro_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/agregador/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Base de datos para Estadísticas
  estadisticas-db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: estadisticas
      TZ: America/Argentina/Buenos_Aires
    ports:
      - "3309:3306"
    volumes:
      - estadisticas-data:/var/lib/mysql
    networks:
      - micro_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Servicio Estadísticas
  estadisticas:
    build:
      context: ..
      dockerfile: backend/estadisticas/Dockerfile
    ports:
      - "8087:8087"
    depends_on:
      estadisticas-db:
        condition: service_healthy
      agregador-db:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    environment:
      # Base de datos Agregador (lectura)
      SPRING_DATASOURCE_AGREGADOR_JDBC_URL: jdbc:mysql://agregador-db:3306/agregador
      SPRING_DATASOURCE_AGREGADOR_USERNAME: root
      SPRING_DATASOURCE_AGREGADOR_PASSWORD: root
      # Base de datos Estadísticas (escritura)
      SPRING_DATASOURCE_ESTADISTICAS_JDBC_URL: jdbc:mysql://estadisticas-db:3306/estadisticas
      SPRING_DATASOURCE_ESTADISTICAS_USERNAME: root
      SPRING_DATASOURCE_ESTADISTICAS_PASSWORD: root
      # ID del servicio
      ESTADISTICAS_ID: 515a5019-9f1a-435e-a320-ebc99687bdc7
      # Eureka
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_HOSTNAME: estadisticas
    networks:
      - micro_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8087/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # API Pública
  api-publica:
    build:
      context: ..
      dockerfile: backend/apiPublica/Dockerfile
    ports:
      - "8085:8085"
    depends_on:
      agregador:
        condition: service_healthy
      estadisticas:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    environment:
      # IDs de servicios
      AGREGADOR_ID: 515a5019-9f1a-435e-a320-ebc99687bdc7
      ESTADISTICAS_ID: 515a5019-9f1a-435e-a320-ebc99687bdc7
      # Eureka
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_HOSTNAME: api-publica
    networks:
      - micro_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # API Administrativa
  api-administrativa:
    build:
      context: ..
      dockerfile: backend/apiAdministrativa/Dockerfile
    ports:
      - "8086:8086"
    depends_on:
      agregador:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    environment:
      # ID del agregador
      AGREGADOR_ID: 515a5019-9f1a-435e-a320-ebc99687bdc7
      # Eureka
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_HOSTNAME: api-administrativa
    networks:
      - micro_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Interfaz Agregador (Frontend)
  interfaz-agregador:
    build:
      context: ..
      dockerfile: frontend/interfaz-agregador/Dockerfile
    depends_on:
      api-publica:
        condition: service_healthy
      api-administrativa:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    ports:
      - "8094:8094"
    environment:
      # Eureka
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_HOSTNAME: interfaz-agregador
    networks:
      - micro_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8094/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  micro_net:
    driver: bridge

volumes:
  agregador-data:
  estadisticas-data:

#  docker-compose -f docker-compose-servicios+bd.yml up -d --build