<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Menú UI</title>
  <style>
    .seccion { display: none; margin-top: 20px; }
    .menu { margin-top: 20px; }
    button { margin: 5px; padding: 8px 12px; }
    label { display: block; margin-top: 5px; }
    .multimedia-item { border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 8px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .row > label { flex: 1 1 220px; }
    .item-actions { display:flex; justify-content:flex-end; }
  </style>
</head>
<body>
<h1>Menú Principal</h1>
<div class="menu">
  <button onclick="mostrarSeccion('contribuyente')">1. Crear Contribuyente</button>
  <button onclick="mostrarSeccion('identidad')">2. Agregar Identidad</button>
  <button onclick="mostrarSeccion('hecho')">3. Postear Hecho</button>
</div>

<!-- Sección Crear Contribuyente -->
<div id="contribuyente" class="seccion">
  <h2>Crear Contribuyente</h2>
  <form id="form-contribuyente">
    <label><input type="checkbox" id="esAdmin"> Es Administrador</label>
    <button type="submit">Crear</button>
  </form>
  <button onclick="volverMenu()">Volver al Menú</button>
</div>

<!-- Sección Agregar Identidad -->
<div id="identidad" class="seccion">
  <h2>Agregar Identidad</h2>
  <form id="form-identidad">
    <label>ID Contribuyente: <input id="contribuyenteId"></label>
    <label>Nombre: <input id="nombre"></label>
    <label>Apellido: <input id="apellido"></label>
    <label>Fecha Nacimiento: <input type="date" id="fechaNac"></label>
    <button type="submit">Agregar</button>
  </form>
  <button onclick="volverMenu()">Volver al Menú</button>
</div>

<!-- Sección Postear Hecho -->
<div id="hecho" class="seccion">
  <h2>Postear Hecho</h2>
  <form id="form-hecho">
    <label>Título: <input id="titulo"></label>
    <label>Descripción: <input id="descripcion"></label>
    <label>Nombre Categoría: <input id="nombreCategoria"></label>
    <label>Latitud: <input id="Latitud" type="number" step="any"></label>
    <label>Longitud: <input id="Longitud" type="number" step="any"></label>
    <label>Contenido: <textarea id="Contenido"></textarea></label>
    <label><input type="checkbox" id="anonimato"> Anónimo</label>
    <label>ID de Identidad: <input id="hecho-contribuyenteId"></label>

    <!-- Campos para Contenido Multimedia -->
    <div id="multimedia-container">
      <h3>Contenido Multimedia</h3>
    </div>
    <button type="button" onclick="agregarMultimedia()">Agregar Contenido Multimedia</button>
    <button type="submit">Postear</button>
  </form>
  <button onclick="volverMenu()">Volver al Menú</button>
</div>

<script>
  // --- Utilidades multimedia condicionales ---
  function crearMultimediaItem() {
    const wrapper = document.createElement('div');
    wrapper.className = 'multimedia-item';
    wrapper.innerHTML = `
        <div class="row">
          <label>Tipo:
            <select class="tipo">
              <option value="video">video</option>
              <option value="audio">audio</option>
              <option value="imagen">imagen</option>
            </select>
          </label>
          <label>Formato (ej: mp4, mp3, jpg): <input type="text" class="formato" placeholder="mp4 / mp3 / jpg"></label>
          <label>Tamaño (MB): <input type="number" class="tamanio" step="any" min="0"></label>
          <label data-field="resolucion">Resolución (ej: 1920x1080): <input type="text" class="resolucion" placeholder="1920x1080"></label>
          <label data-field="duracion">Duración (segundos): <input type="number" class="duracion" step="any" min="0"></label>
        </div>
        <div class="item-actions">
          <button type="button" class="eliminar">Eliminar</button>
        </div>
      `;

    const tipoSel = wrapper.querySelector('.tipo');
    const btnEliminar = wrapper.querySelector('.eliminar');

    const actualizarVisibilidad = () => {
      const tipo = tipoSel.value; // video | audio | imagen
      const resoWrap = wrapper.querySelector('[data-field="resolucion"]');
      const duraWrap = wrapper.querySelector('[data-field="duracion"]');

      // Mostrar/ocultar según tipo
      if (tipo === 'video') {
        resoWrap.style.display = '';
        duraWrap.style.display = '';
      } else if (tipo === 'audio') {
        resoWrap.style.display = 'none';
        wrapper.querySelector('.resolucion').value = '';
        duraWrap.style.display = '';
      } else { // imagen
        resoWrap.style.display = '';
        duraWrap.style.display = 'none';
        wrapper.querySelector('.duracion').value = '';
      }
    };

    tipoSel.addEventListener('change', actualizarVisibilidad);
    btnEliminar.addEventListener('click', () => wrapper.remove());

    // Valor inicial y visibilidad inicial
    actualizarVisibilidad();
    return wrapper;
  }

  function agregarMultimedia() {
    const container = document.getElementById('multimedia-container');
    const item = crearMultimediaItem();
    container.appendChild(item);
  }

  // Agregar un ítem por defecto
  document.addEventListener('DOMContentLoaded', () => {
    agregarMultimedia();
  });

  // --- Navegación ---
  function mostrarSeccion(id) {
    document.querySelectorAll('.seccion').forEach(sec => sec.style.display = 'none');
    document.querySelector('.menu').style.display = 'none';
    document.getElementById(id).style.display = 'block';
  }
  function volverMenu() {
    document.querySelectorAll('.seccion').forEach(sec => sec.style.display = 'none');
    document.querySelector('.menu').style.display = 'block';
  }

  // --- Crear Contribuyente ---
  document.getElementById('form-contribuyente').addEventListener('submit', async (e) => {
    e.preventDefault();
    const esAdministrador = document.getElementById('esAdmin').checked;
    const resp = await fetch('http://localhost:8082/fuentesDinamicas/contribuyentes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ esAdministrador })
    });
    if (!resp.ok) {
      const msg = await resp.text().catch(() => 'Error desconocido');
      alert('Error al crear contribuyente: ' + msg);
      return;
    }
    const data = await resp.json();
    alert('Contribuyente creado con ID: ' + (data.contribuyenteId ?? JSON.stringify(data)));
  });

  // --- Agregar Identidad ---
  document.getElementById('form-identidad').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('contribuyenteId').value;
    const body = {
      nombre: document.getElementById('nombre').value,
      apellido: document.getElementById('apellido').value,
      fechaNacimiento: document.getElementById('fechaNac').value
    };
    const resp = await fetch(`http://localhost:8082/fuentesDinamicas/contribuyentes/${id}/identidades`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    alert(resp.ok ? 'Identidad agregada' : 'Error al agregar identidad');
  });

  // --- Postear Hecho ---
  document.getElementById('form-hecho').addEventListener('submit', async (e) => {
    e.preventDefault();

    // Construir multimedia según tipo
    const items = Array.from(document.querySelectorAll('#multimedia-container .multimedia-item'));
    const contenidoMultimedia = items.map((item) => {
      const tipo = item.querySelector('.tipo').value; // video|audio|imagen
      const formato = item.querySelector('.formato').value.trim();
      const tamanioVal = parseFloat(item.querySelector('.tamanio').value);
      const tamanio = Number.isFinite(tamanioVal) ? tamanioVal : undefined;
      const resolucion = item.querySelector('.resolucion').value.trim();
      const durVal = parseFloat(item.querySelector('.duracion').value);
      const duracion = Number.isFinite(durVal) ? durVal : undefined;

      const base = { tipo, formato, tamanio };
      if (tipo === 'video') {
        return { ...base, resolucion, duracion };
      } else if (tipo === 'audio') {
        return { ...base, duracion };
      } else { // imagen
        return { ...base, resolucion };
      }
    })
            // Filtrar entradas vacías (sin formato ni tamaño)
            .filter(m => (m.formato && m.formato.length) || (typeof m.tamanio === 'number'));

    // Validación mínima
    for (const [idx, m] of contenidoMultimedia.entries()) {
      if (!m.formato) {
        alert(`Multimedia #${idx + 1}: faltó el formato (jpg, mp4, mp3, etc).`);
        return;
      }
      if (typeof m.tamanio !== 'number' || m.tamanio < 0) {
        alert(`Multimedia #${idx + 1}: el tamaño (MB) debe ser un número ≥ 0.`);
        return;
      }
      if (m.tipo === 'video' && (!m.resolucion || typeof m.duracion !== 'number')) {
        alert(`Multimedia #${idx + 1}: para video se requiere resolución y duración.`);
        return;
      }
      if (m.tipo === 'audio' && typeof m.duracion !== 'number') {
        alert(`Multimedia #${idx + 1}: para audio se requiere duración.`);
        return;
      }
      if (m.tipo === 'imagen' && !m.resolucion) {
        alert(`Multimedia #${idx + 1}: para imagen se requiere resolución.`);
        return;
      }
    }

    const body = {
      titulo: document.getElementById('titulo').value,
      descripcion: document.getElementById('descripcion').value,
      categoria: { nombre: document.getElementById('nombreCategoria').value },
      ubicacion: {
        latitud: parseFloat(document.getElementById('Latitud').value),
        longitud: parseFloat(document.getElementById('Longitud').value)
      },
      fechaAcontecimiento: new Date().toISOString(),
      origen: 'CARGA_MANUAL',
      contenidoTexto: document.getElementById('Contenido').value,
      contenidoMultimedia,
      anonimato: document.getElementById('anonimato').checked,
      identidadId: document.getElementById('hecho-contribuyenteId').value
    };
    console.log('Cuerpo de la solicitud:', body);

    try {
      const resp = await fetch('http://localhost:8082/fuentesDinamicas/hechos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (!resp.ok) {
        const msg = await resp.text().catch(() => 'Error desconocido');
        alert('Error al publicar el hecho: ' + msg);
        return;
      }
      alert('Hecho publicado');
    } catch (err) {
      alert('Error de red al publicar: ' + (err?.message || err));
    }
  });

  // Nota: Se removió el listener de un formulario inexistente (form-solicitud)
</script>
</body>
</html>